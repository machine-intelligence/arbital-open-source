{{/* page.tmpl is the base template file for displaying a page. */}}
{{define "base"}}
<!DOCTYPE html>
<html lang="en">
<head>
	<title>{{.Page.Title}} - Zanaduu</title>
	{{template "style"}}
	{{template "scripts"}}
	{{template "angular" .}}
	<script src="/static/js/page.js"></script>
	<script src="/static/js/editPage.js"></script>
	<script>
		// Map of alias -> {pageId, title} object.
		var pageAliases = { {{range .AliasMap}}"{{.FullName}}":{pageId:{{.PageId}}, title:"{{.PageTitle}}"},{{end}} };
		// Map of link alias/id -> true if the page is published.
		var gPageLinks = { {{range $k,$v := .Page.Links}}"{{$k}}": {{$v}},{{end}} };
	</script>
	<script>
		// MainCtrl is for the Page page.
		app.controller("MainCtrl", function($scope, pageService, userService) {
			$scope.relatedIds = {{.RelatedIds}};
			$scope.questionIds = [];
			$scope.page = pageService.pageMap["{{.Page.PageId}}"];

			// Set up children pages and question ids.
			$scope.initialChildren = {};
			var childrenLen = $scope.page.Children.length;
			for (var n = 0; n < childrenLen; n++) {
				var id = $scope.page.Children[n].ChildId;
				var page = pageService.pageMap[id];
				if (page.Type === "question") {
					$scope.questionIds.push(id);
				} else {
					$scope.initialChildren[id] = page;
				}
			}

			// Sort question ids by likes, but put the ones created by current user first.
			$scope.questionIds.sort(function(id1, id2) {
				var page1 = pageService.pageMap[id1];
				var page2 = pageService.pageMap[id2];
				var ownerDiff = (page2.Author.Id == userService.user.Id ? 1 : 0) -
						(page1.Author.Id == userService.user.Id ? 1 : 0);
				if (ownerDiff != 0) return ownerDiff;
				return page2.LikeScore - page1.LikeScore;
			});

			// Set up parents pages.
			$scope.initialParents = {};
			var parentsLen = $scope.page.Parents.length;
			for (var n = 0; n < parentsLen; n++) {
				var id = $scope.page.Parents[n].ParentId;
				$scope.initialParents[id] = pageService.pageMap[id];
			}

			// Setup Page JS Controller.
			$scope.pageJsController = new PageJsController($scope.page, pageService, $("body"), userService);
			$scope.pageJsController.start();
		});
	</script>
</head>

<body page-id="{{.Page.PageId}}" page-type="{{.Page.Type}}" page-url="{{GetPageUrl .Page}}" last-visit="{{.Page.LastVisit}}" has-vote="{{if .Page.HasVote}}true{{end}}" ng-app="zanaduu" ng-controller="ZanaduuCtrl">
{{template "navbar" .User}}

<!-- This div shows up when the user hovers over an intra-site link. -->
<div id="link-popover-template" hidden>
	<span class="popover-summary"></span>

	<!-- Likes / dislikes and approval voting -->
	<div class="like-span">
		<span class="like-count">JS inserts likes</span>
		<span class="disabled-like glyphicon glyphicon-thumbs-up"></span>
		&nbsp;
		<span class="dislike-count">JS inserts dislikes</span>
		<span class="disabled-dislike glyphicon glyphicon-thumbs-down"></span>
	</div>

	<!-- Answers and probability votes -->
	<div class="vote"></div>
</div>

<!-- This div is used to create vote divs. -->
<div id="vote-template" class="vote" hidden>
	<div class="bar-background"></div>
	<input class="vote-slider-input" data-slider-id="vote-slider" type="text"/>
	<div class="text-center gray-text">
		<span class="vote-count">0 votes</span> counted
		<span class="my-vote">
			<span class="my-vote-value"></span>
			<a href="#" class="delete-my-vote-link glyphicon glyphicon-remove"></a>
		</span>
	</div>
</div>

<!-- This div is used to create embedded page divs. -->
<div id="embedded-page-template" class="embedded-page" hidden>
	<div>
		<h2>
			<a href="#" class="hide-embedded-page glyphicon glyphicon-triangle-bottom"></a>&nbsp;
			<a href="#" class="embedded-page-title">JS inserts title here</a>
		</h2>
	</div>
	<div class="embedded-page-body">
		<div class="embedded-vote-container"></div>
		<div class="embedded-page-text">JS inserts page text here</div>
	</div>
</div>

<!-- This modal is for asking a new question. -->
<znd-edit-page-modal parent-page-id="'{{.Page.PageId}}'" resume-page-id="'{{.Page.QuestionDraftId}}'"></znd-edit-page-modal>

{{with .Page}}
	{{if gt .DeletedBy 0}}
		<div class="page-body-div">
			<div class="alert alert-danger">This page has been deleted.
				{{if IsAdmin}}
					<span class="admin">By id: {{.DeletedBy}}. <a href="#" class="undo-page-delete">Undo.</a></span>
				{{end}}
			</div>
		</div>
	{{else}}
		<div class="page-body-div" ng-controller="MainCtrl">
			<!-- Navigation column -->
			<div class="navigation-column pull-left">
				<!-- Siblings -->
				<div class="panel panel-default">
					<div class="panel-heading">Related</div>
					<div class="panel-body">
						<znd-likes-page-title page-id="pageId" ng-repeat="pageId in relatedIds"></znd-likes-page-title>
					</div>
				</div>
		
				<!-- Parents -->
				<div class="panel panel-default">
					<div class="panel-heading">Parents</div>
					<div class="panel-body">
						<znd-page-tree init-map="initialParents" is-parent-tree="true"></znd-page-tree>
					</div>
				</div>
		
				<!-- Children -->
				<div class="panel panel-default">
					<div class="panel-heading">Children</div>
					<div class="panel-body">
						<znd-page-tree init-map="initialChildren"></znd-page-tree>
					</div>
				</div>
		
				<!-- Questions -->
				<div class="panel panel-default" ng-show="false">
					<div class="panel-heading">Questions</div>
					<div class="panel-body">
						<znd-likes-page-title page-id="pageId" ng-repeat="pageId in questionIds"></znd-likes-page-title>
					</div>
				</div>
			</div>

			<!-- Left column -->
			<div class="left-column pull-left">
				<!-- Likes / dislikes and approval voting -->
				<div class="page-like-div pull-right" my-like="{[{page.MyLikeValue}]}">
					<div class="pull-right">
						<span class="like-count" ng-bind="page.LikeCount"></span>
						<a href="#"
						   class="like-link glyphicon glyphicon-thumbs-up"
							 ng-class="{'on': page.MyLikeValue >= 1}"
							 title="This is a high quality page"
							 ng-show="userService.user.IsLoggedIn"></a>
						<span class="disabled-like glyphicon glyphicon-thumbs-up" ng-hide="userService.user.IsLoggedIn"></span>
					</div>
					<div class="clearfix"></div>
					<div class="pull-right">
						<span class="dislike-count" ng-bind="page.DislikeCount"></span>
						<a href="#"
							 class="dislike-link glyphicon glyphicon-thumbs-down"
							 ng-class="{'on': page.MyLikeValue <= -1}"
							 title="This is a low quality page"
							 ng-show="userService.user.IsLoggedIn"></a>
						<span class="disabled-dislike glyphicon glyphicon-thumbs-down" ng-hide="userService.user.IsLoggedIn"></span>
					</div>
				</div>
				<div class="clearfix"></div>

				<!-- Page icons like subscribe, edit, and delete. -->
				<div class="page-glyphs pull-right">
					<a href="#"
						 class="subscribe-to-page-link glyphicon glyphicon-eye-open"
						 ng-class="{'on': page.IsSubscribed}"
						 title="Subscribe to receive updates when this page changes or gets new comments"
						 ng-show="userService.user.IsLoggedIn"></a>
					<a ng-href="{[{page.EditUrl}]}"
						 class="edit-page-link glyphicon glyphicon-pencil"
						 ng-class="{'admin': page.getEditLevel() == 'admin'}"
						 title="Edit this page"
						 ng-show="page.getEditLevel() == '' || page.getEditLevel() == 'admin'"></a>
					<a href="#"
						 class="delete-page-link glyphicon glyphicon-remove"
						 ng-class="{'admin': page.getDeleteLevel() == 'admin'}"
						 title="Delete this page"
						 ng-show="page.getDeleteLevel() == '' || page.getDeleteLevel() == 'admin'"></a>
				</div>
				<div class="clearfix"></div>

				<!-- Alert to check if the user really wants to delete a page. -->
				<div class="alert alert-danger fade in" id="delete-page-alert" hidden>
					<p>Are you sure you want to delete this page?</p>
					<button type="button" class="delete-page-confirm btn btn-danger">Delete</button>
					<button type="button" class="delete-page-cancel btn btn-default">Cancel</button></br>
				</div>
			</div>
		
			<!-- Main page column -->
			<div class="mid-column pull-left">
				<znd-page-title page-id="page.PageId" class="page-title"></znd-page-title>
				<div class="author-text" ng-show="page.Type == 'blog'">by {{template "userName" .Author}}</div>

				<!-- Probability voting -->
				<div id="main-page-vote" ng-show="page.HasVote"></div>

				<!-- Main page text. Populated by JS. -->
				<div class="page-text"></div>
		
				<!--Admin stuff -->
				{{if IsAdmin}}
					<span class="admin">Last Visit: {[{page.LastVisit}]}; Last Edit At: {[{page.CreatedAt}]} by {{template "userName" .Author}}</span></br>
				{{end}}

				<!-- Comments -->
				<b id="comments-label">Comments:</b></br>
				<div class="comments">
					{{range .Comments}}
						{{template "comment" .}}
					{{end}}
					{{template "newComment" 0}}
				</div>
			</div>

			<!-- Question button -->
			<div class="question-div pull-left" ng-show="false">
				<button type="button" class="question-button btn btn-info">
				  <span class="glyphicon glyphicon-question-sign"></span>
					<span class="has-question-draft-icon glyphicon glyphicon-pencil" ng-show="page.QuestionDraftId > 0"></span>
				</button>
			</div>
			<div class="clearfix"></div>
		</div>
	{{end}}
{{end}}

{{template "footer"}}
</body>
</html>
{{end}}
