<div class="full-height md-whiteframe-1dp"
		ng-class="::{'layout-row': fullView, 'layout-column': !fullView}"
		ng-keyup="handleKeyPress($event)">
	<!-- Main edit column (left half) -->
	<div class="md-primary"
			layout="column"
			flex="{{::(fullView ? '50' : undefined)}}"
			ng-show="!inPreview && (fullView || (!otherDiff && !sideEdit))">
		<md-tabs ng-class="::{'hide-tabs': isComment}"
				class="md-primary md-hue-2"
				md-selected="selectedTab"
				md-stretch-tabs="{{::(gtXSmallScreen ? 'always' : 'never')}}"
				layout="column"
				flex>
			<!-- (0) Title tab -->
			<md-tab label="Title" ng-disabled="::(isComment)">
				<div flex>
					<div class="editor-tab" layout="column">
						<md-input-container>
							<label>Title</label>
							<input ng-model="page.title" md-maxlength="{{::(isLens ? 50 : 100)}}" autofocus>
						</md-input-container>
						<md-input-container>
							<label>Clickbait</label>
							<input ng-model="page.clickbait" md-maxlength="200">
						</md-input-container>
						<md-input-container>
							<label>Alias</label>
							<input ng-model="page.alias" md-maxlength="50">
						</md-input-container>
					</div>

					<!-- Related pages -->
					<md-list ng-if="::!page.wasPublished">
						<md-subheader class="md-primary md-hue-1 md-no-sticky" ng-if="similarPages.length > 0">
							<span class="black-font">Similar pages</span>
						</md-subheader>
						<md-list-item layout="row" ng-repeat="(index,similarPage) in similarPages">
							<arb-likes page-id="{{::similarPage.pageId}}"></arb-likes>
							<arb-page-title page-id="{{::similarPage.pageId}}" is-link="true" show-clickbait="true"></arb-page-title>
						</md-list-item>
					</md-list>
				</div>
			</md-tab>

			<!-- (1) Text tab -->
			<md-tab label="Text">
				<div layout="column" flex>
					<div layout="row" ng-show="showInsertLink">
						<md-button class="md-icon-button" ng-click="insertLinkSelect()">
							<md-icon>close</md-icon>
						</md-button>
						<!-- Input we show when entering a new link -->
						<arb-autocomplete class="insert-autocomplete"
								placeholder="Search for a page to link"
								on-select="insertLinkSelect(result)"
								flex></arb-autocomplete>
					</div>

					<!-- Markdown toolbar -->
					<div id="wmd-button-bar{{::page.pageId}}"
							class="wmd-button-bar"
						 	layout="row"
							ng-show="!showInsertLink && !freezeEdit">
						<md-button ng-class="{'md-primary': showSnapshotText}"
									ng-click="toggleSnapshotting()"
									ng-if="::!isComment">
							<md-icon>save</md-icon>
							<md-tooltip md-delay="500">Snapshot</md-tooltip>
						</md-button>
						<div class="separator"></div>
						<md-button class="wmd-bold-button">
							<md-icon>format_bold</md-icon>
							<md-tooltip md-delay="500">**Bold** | Ctrl+B</md-tooltip>
						</md-button>
						<md-button class="wmd-italic-button">
							<md-icon>format_italic</md-icon>
							<md-tooltip md-delay="500">*Italics* | Ctrl+I</md-tooltip>
						</md-button>
						<div class="separator"></div>
						<md-button class="wmd-link-button">
							<md-icon>insert_link</md-icon>
							<md-tooltip md-delay="500">[hyper](link) | Ctrl+L</md-tooltip>
						</md-button>
						<md-button class="wmd-intralink-button">
							<md-icon md-svg-icon="link_variant"></md-icon>
							<md-tooltip md-delay="500">[Intrasite link] | Ctrl+;</md-tooltip>
						</md-button>
						<div layout="row" ng-show="::gtSmallScreen">
							<div class="separator" ng-show="::!insideDialog"></div>
							<md-button class="wmd-new-page-button" ng-show="::!insideDialog">
								<md-icon>note_add</md-icon>
								<md-tooltip md-delay="500">[New page link] | Ctrl+P</md-tooltip>
							</md-button>
							<md-button class="wmd-new-child-button" ng-show="::!(insideDialog || !isWiki)">
								<md-icon>child_care</md-icon>
								<md-tooltip md-delay="500">[New child link] | Ctrl+Shift+P</md-tooltip>
							</md-button>
							<md-button class="wmd-new-sibling-button" ng-show="::!(insideDialog || !isWiki)">
								<md-icon>people</md-icon>
								<md-tooltip md-delay="500">[New sibling link] | Ctrl+Shift+S</md-tooltip>
							</md-button>
						</div>
						<div layout="row" ng-show="::gtXSmallScreen">
							<div class="separator"></div>
							<md-button class="wmd-quote-button">
								<md-icon>format_quote</md-icon>
								<md-tooltip md-delay="500">&gt; Blockquote | Ctrl+Q</md-tooltip>
							</md-button>
							<md-button class="wmd-code-button">
								<md-icon>format_clear</md-icon>
								<md-tooltip md-delay="500">`Preformatted` | Ctrl+K</md-tooltip>
							</md-button>
							<md-button class="wmd-image-button">
								<md-icon>insert_photo</md-icon>
								<md-tooltip md-delay="500">![image](url) | Ctrl+G</md-tooltip>
							</md-button>
						</div>
						<div class="separator"></div>
						<md-button class="wmd-olist-button">
							<md-icon>format_list_numbered</md-icon>
							<md-tooltip md-delay="500">1. Numbered list | Ctrl+O</md-tooltip>
						</md-button>
						<md-button class="wmd-ulist-button">
							<md-icon>format_list_bulleted</md-icon>
							<md-tooltip md-delay="500">* Bullet list | Ctrl+U</md-tooltip>
						</md-button>
						<md-button class="wmd-heading-button">
							<md-icon md-svg-icon="format_header_pound"></md-icon>
							<md-tooltip md-delay="500"># Heading | Ctrl+H</md-tooltip>
						</md-button>
						<div layout="row" ng-show="::gtXSmallScreen">
							<md-button class="wmd-hr-button" ng-show="::gtSmallScreen">
								<md-icon>remove</md-icon>
								<md-tooltip md-delay="500">--- Line | Ctrl+E</md-tooltip>
							</md-button>
							<div class="separator"></div>
							<md-button class="wmd-undo-button">
								<md-icon>undo</md-icon>
								<md-tooltip md-delay="500">Undo | Ctrl+Z</md-tooltip>
							</md-button>
							<md-button class="wmd-redo-button">
								<md-icon>redo</md-icon>
								<md-tooltip md-delay="500">Redo | Ctrl+Shift+Z</md-tooltip>
							</md-button>
						</div>
						<div flex></div>
						<md-button ng-href="{{::pageService.getEditPageUrl(page.pageId)}}" ng-show="::(isEmbedded && !insideDialog)">
							<md-icon>fullscreen</md-icon>
							<md-tooltip md-delay="500">Go to full-windowed edit page</md-tooltip>
						</md-button>
						<div class="separator" ng-show="::(isEmbedded && !insideDialog)"></div>
						<md-button href="http://math.stackexchange.com/editing-help" target="_blank">
							<md-icon>live_help</md-icon>
							<md-tooltip md-delay="500">Markdown editing help</md-tooltip>
						</md-button>
					</div>

					<!-- Input we show when the user wants to snapshot the page. -->
					<div layout="row" ng-if="showSnapshotText">
						<input class="snapshot-text" ng-model="page.snapshotText" flex>
						<md-button class="md-primary md-hue-1 md-raised" ng-click="snapshotPage()">
								<md-tooltip md-delay="500">Save snapshot</md-tooltip>
							Snapshot
						</md-button>
					</div>

					<!-- Textarea for editing the page's text -->
					<textarea class="wmd-input"
							id="wmd-input{{::page.pageId}}"
							placeholder="Truth is singular. Its &#34;versions&#34; are mistruths.&#13;&#10;&mdash; Sonmi-451"
							ng-model="page.text" autofocus
							flex
							ng-disabled="showInsertLink || freezeEdit"></textarea>
				</div>
			</md-tab>

			<!-- (2) Relationships tab -->
			<md-tab label="Relationships" ng-disabled="::isComment">
				<div class="editor-tab" flex>
					<!-- Parents -->
					<div arb-relationships class="edit-relationship-div"
							page-id="{{::page.pageId}}"
							type="parent"
							force-edit-mode="true"
							readonly="::!(isWiki || isQuestion)"></div>

					<!-- Tags -->
					<div arb-relationships class="edit-relationship-div"
							page-id="{{::page.pageId}}"
							type="tag"
							force-edit-mode="true"
							readonly="::!(isWiki || isQuestion)"></div>

					<!-- Requirements -->
					<div arb-relationships class="edit-relationship-div"
							page-id="{{::page.pageId}}"
							type="requirement"
							force-edit-mode="true"
							readonly="::!(isWiki || isLens || isQuestion)"></div>

					<!-- Teaches -->
					<div arb-relationships class="edit-relationship-div"
							page-id="{{::page.pageId}}"
							type="subject"
							force-edit-mode="true"
							readonly="::!(isWiki || isLens)"></div>

					<!-- Lens ordering -->
					<div class="edit-relationship-div" ng-if="::!isLens">
						<div class="md-subhead">
							<!-- HARDCODED -->
							<arb-page-title page-id="17b"
									is-link="true"
									custom-page-title="'Lens order'"></arb-page-title>
							<div class="md-caption">
								Sorted from most technical to most simple. (Main lens is always the most technical.)
							</div>
						</div>
						<div class="md-caption" ng-if="page.lensIds.length <= 0">This page has no lenses.</div>

						<!-- List of lenses -->
						<div data-as-sortable="::lensSortListeners" data-ng-model="page.lensIds" ng-if="page.lensIds.length > 0">
							<div data-ng-repeat="lensId in page.lensIds" data-as-sortable-item>
								<div class="md-primary md-hue-1 md-whiteframe-1dp" data-as-sortable-item-handle>
									<md-icon>reorder</md-icon>
									<span>#{{pageService.pageMap[lensId].lensIndex}}&nbsp;</span>
									<arb-page-title page-id="{{::lensId}}" is-link="true"></arb-page-title>
								</div>
							</div>
						</div>
					</div>

					<!-- List of strings (for questions) -->
					<div ng-if="isQuestion">
						<div class="md-subhead">
							<arb-page-title page-id="35z"
									is-link="true"
									custom-page-title="'Search strings'"></arb-page-title>
						</div>
						<div layout="row"
								layout-align="start center"
								ng-repeat="(id,text) in page.searchStrings">
							<!-- Delete button -->
							<md-button class="md-icon-button" ng-click="deleteSearchString(id)">
								<md-icon>delete</md-icon>
							</md-button>
					
							<!-- Relationship page title -->
							<span ng-bind="text"></span>
						</div>

						<!-- Add a new string -->
						<br>
						<div layout="row" layout-align="start start">
							<md-input-container layout-fill>
								<label>New search string</label>
								<input ng-model="addSearchStringData.text">
							</md-input-container>
							<md-button class="md-primary" ng-click="addSearchString()">
								Add string
							</md-button>
						</div>
					</div>

					<!-- Info about how many incoming marks there are. -->
					<div ng-if="isQuestion">
						<div class="md-subhead">
							<arb-page-title page-id="370"
									is-link="true"
									custom-page-title="'Linked marks'"></arb-page-title>
						</div>
						<span>
							{{pageService.pageMap[page.pageId].linkedMarkCount}} 
							<ng-pluralize count="pageService.pageMap[page.pageId].linkedMarkCount" when="{'0': 'marks are', 'one': 'mark is', 'other': 'marks are'}"></ng-pluralize>
							linked to this question.
						</span>
					</div>

					<br>
					<br>

				</div>
			</md-tab>

			<!-- (3) Settings tab -->
			<md-tab label="Settings" ng-disabled="::isComment || isGroup">
				<div layout="column" flex>
					<md-content class="editor-tab" flex>
						<!-- Alias -->
						<div layout="row" ng-if="::(!isComment && !isGroup)">
							<div layout="column" flex>
								<md-input-container>
									<label>Alias</label>
									<input ng-model="page.alias" md-maxlength="50">
								</md-input-container>
							</div>
							<div class="md-caption" layout-margin flex>
								<div>Unique name for this page, e.g. "human_health"</div>
								<div ng-if="page.seeGroupId != ''">
									This alias will be prefixed with "{{pageService.pageMap[page.seeGroupId].alias}}."
									because it's part of the private domain
								</div>
							</div>
						</div>

						<!-- See group id -->
						<div layout="row" ng-if="::!page.wasPublished">
							<md-input-container flex>
								<label>See group</label>
								<md-select ng-model="page.seeGroupId">
									<md-option ng-repeat="(key,value) in ::groupOptions" value="{{::key}}" ng-bind="::value"></md-option>
								</md-select>
							</md-input-container>
							<div class="md-caption" layout-margin flex>
								Group that can see this page. If not set, anyone can see it
							</div>
						</div>

						<!-- Edit group id -->
						<div layout="row">
							<md-input-container flex>
								<label>Edit group</label>
								<md-select ng-model="page.editGroupId">
									<md-option ng-repeat="(key,value) in ::groupOptions" value="{{::key}}" ng-bind="::value"></md-option>
								</md-select>
							</md-input-container>
							<div class="md-caption" layout-margin flex>
								Group that can edit this page. If not set, anyone can edit it
							</div>
						</div>

						<!-- Karma edit lock -->
						<div layout="row" ng-if="::(userService.user.maxKarmaLock > 0 && !isComment)">
							<div flex>
								<label>Edit karma lock</label>
								<md-slider aria-label="Edit karma lock"
										md-discrete
										ng-model="page.editKarmaLock"
										step="10" min="0" max="{{::userService.user.maxKarmaLock}}">
								</md-slider>
							</div>
							<div class="md-caption" layout-margin flex>
								Editing this page will require <span ng-bind="page.editKarmaLock"></span> karma
							</div>
						</div>

						<!-- Page type -->
						<div layout="row">
							<md-input-container flex>
								<label>Page type</label>
								<md-select ng-model="page.type" required="true">
									<md-option ng-repeat="(key,value) in ::pageTypes" value="{{::key}}" ng-bind="::value"></md-option>
								</md-select>
							</md-input-container>
							<div class="md-caption" layout-margin flex>
								<span ng-if="::isWiki">
									Standard wiki page
								</span>
								<span ng-if="::isLens">
									A lens page is used to present the same material as another page but with a different emphasis
								</span>
							</div>
						</div>

						<!-- Show/hide vote -->
						<div layout="row" layout-margin ng-if="::(page.lockedVoteType != '' && isWiki)">
							<md-switch ng-model="page.hasVote">
								Show the {{::page.lockedVoteType}} voting bar
							</md-switch>
						</div>

						<!-- Vote type -->
						<div layout="row" ng-if="::(page.lockedVoteType == '' && !isQuestion && !isComment)">
							<md-input-container flex>
								<label>Voting</label>
								<md-select ng-model="page.voteType">
									<md-option ng-repeat="(key,value) in ::voteTypes" value="{{::key}}">
										{{::value}}
									</md-option>
								</md-select>
							</md-input-container>
							<div layout-margin flex>
								<!-- TODO: helpful notes -->
							</div>
						</div>

						<!-- Sort children option -->
						<div layout="row" layout-align="start center" ng-if="::!isSecondary">
							<md-input-container flex>
								<label>Sort children</label>
								<md-select ng-model="page.sortChildrenBy">
									<md-option ng-repeat="(key,value) in ::sortTypes" value="{{::key}}">
										{{::value}}
									</md-option>
								</md-select>
							</md-input-container>
							<div class="md-caption" layout-margin flex>
								How to sort the children of this page
								<!-- TODO: helpful notes about specific types -->
							</div>
						</div>

						<!-- Is requisite -->
						<div layout="row" layout-margin ng-if="::isWiki">
							<md-switch ng-model="page.isRequisite">
								This page is used as a requisite
							</md-switch>
						</div>

						<!-- Indirect teacher -->
						<div layout="row" layout-margin ng-if="::isWiki">
							<md-switch ng-model="page.indirectTeacher">
								This page teaches its requisites indirectly
							</md-switch>
						</div>

						<!-- Merge question -->
						<div layout="row" layout-margin ng-if="::isQuestion">
							<div flex>
								<arb-autocomplete class="insert-autocomplete"
										placeholder="Find the question to merge into"
										on-select="selectedMergeQuestion(result)"
										do-autofocus="false"
										flex
										page-type="question"
										ng-show="!mergeCandidate"></arb-autocomplete>
								<arb-page-title page-id="{{::mergeCandidate.pageId}}"
										is-link="true"
										show-clickbait="true"
										ng-if="mergeCandidate"></arb-page-title>
								<arb-confirm-button button-text="Merge"
										button-before-confirm="true"
										confirmed="mergeQuestion()"
										ng-if="mergeCandidate"></arb-confirm-button>
							</div>
							<div class="md-caption" flex>
								This will merge all answers and search strings into the selected question. This question will be deleted.
							</div>
						</div>

						<!-- Delete page -->
						<arb-confirm-button button-text="Delete page"
								button-before-confirm="true"
								confirmed="deletePage()"></arb-confirm-button>
					</md-content>
				</div>
			</md-tab>

			<!-- (4) Changelog tab -->
			<md-tab label="Changelog" ng-disabled="::(isComment)">
				<div class="md-caption" layout-padding ng-if="::(page.changeLogs.length <= 0)">No changes yet</div>
				<md-list class="editor-tab" flex>
					<md-list-item ng-repeat="(index,changeLog) in ::page.changeLogs">
						<arb-change-log-entry page-id="{{::page.pageId}}" change-log="::changeLog" flex></arb-change-log-entry>
						<md-divider ng-if="::!$last"></md-divider>
					</md-list-item>
				</md-list>
			</md-tab>
		</md-tabs>

		<!-- Footer -->
		<div class="edit-page-footer md-primary md-hue-2" layout="row" layout-align="start center" layout-margin>
			<!-- Go back button -->
			<div layout="column" ng-if="::!isEmbedded">
				<md-button ng-href="{{::pageService.getPageUrl(page.pageId)}}" class="md-primary md-hue-1 md-raised">
					<md-icon>arrow_back</md-icon>
					Back
					<md-tooltip md-delay="500">Go to live view</md-tooltip>
				</md-button>
			</div>
			<md-checkbox ng-model="page.isEditorComment" ng-if="::isComment">
				<span ng-if="::!gtXSmallScreen">For editors</span>
				<span ng-if="::gtXSmallScreen">Show comment to page editors only</span>
			</md-checkbox>
			<div class="no-margins" flex></div>

			<div layout="row" layout-align="end center" flex ng-if="::gtXSmallScreen">
				<div ng-if="autosaving">
					Autosaving...
				</div>
				<div ng-if="successfulAutosave">
					Autosaved
				</div>
				<div ng-if="snapshotting">
					Saving a snapshot...
				</div>
				<div ng-if="publishing">
					Publishing...
				</div>
				<div ng-if="selectedTab == 2">All relationship changes are published instantly</div>
			</div>

			<arb-confirm-button button-text="Discard"
					confirmed="discardPage()"
					disabled="publishing || snapshotting"
					tooltip-text="Discard the autosave"
					ng-if="selectedTab != 2 && isPageDirty && !freezeEdit"></arb-confirm-button>
			<div ng-if="!fullView && !inPreview && (selectedTab != 2) && !freezeEdit">
				<md-button class="md-primary md-hue-1 md-raised"
						ng-click="togglePreview(true)"
						ng-disable="publishing || snapshotting">
					<md-tooltip md-delay="500">Preview the page before publishing</md-tooltip>
					Preview
				</md-button>
			</div>
			<div ng-if="selectedTab != 2 && !freezeEdit">
				<md-button class="md-primary md-raised"
						ng-click="publishPage()"
						ng-disable="publishing || snapshotting">
					<!-- Don't show for comments, because when inline comment gets created the tooltip remains -->
					<md-tooltip md-delay="500" ng-if="::!isComment">Make this version live</md-tooltip>
					Publish
				</md-button>
			</div>
		</div>
	</div>

	<!-- Right half -->
	<div ng-class="::{'edit-page-rhs-border': fullView}"
			layout="column"
			flex="{{fullView ? '50' : (inPreview || otherDiff || sideEdit) ? '' : 'none'}}">
		<!-- Messages -->
		<md-list ng-if="!otherDiff && !sideEdit">
			<md-list-item class="no-margins"
					ng-class="::({error: 'md-warn bold', warning: 'md-warn md-hue-1', info: 'md-primary md-hue-1'}[value.type])"
					ng-repeat="(key,value) in messages">
				<!-- Dismiss button -->
				<md-button class="md-icon-button"
						ng-click="deleteMessage(key)"
						ng-if="::!value.permanent">
					<md-icon>close</md-icon>
				</md-button>
				<div ng-bind="::value.text"></div>
			</md-list-item>
		</md-list>

		<!-- Live preview -->
		<md-content class="preview-area" flex ng-show="(fullView || inPreview) && !otherDiff && !sideEdit">
			<div class="md-display-3" ng-bind="page.title"></div>
			<div class="md-caption" ng-if="page.title === '' && page.text === ''">
				<div class="md-display-3">Live preview</div>
			</div>
			<div id="wmd-preview{{::page.pageId}}"></div>
		</md-content>

		<!-- Buttons shown in preview -->
		<div class="md-primary md-hue-2"
				layout="row"
				layout-align="space-between center"
				ng-if="inPreview">
			<div layout-margin>
				<md-button class="md-primary md-hue-1 md-raised" ng-click="togglePreview(false)">
					<md-icon>arrow_back</md-icon>
					Editing
					<md-tooltip md-delay="500">Go back to editing</md-tooltip>
				</md-button>
			</div>
			<div layout-margin>
				<md-button class="md-raised md-primary" ng-click="publishPage()">
					Publish
					<md-tooltip md-delay="500">Make this version live</md-tooltip>
				</md-button>
			</div>
		</div>

		<!-- Diff between edits -->
		<md-content layout-padding flex ng-if="otherDiff">
			<h2 class="md-display-3" ng-bind="'(#' + otherDiff.edit + ') ' + otherDiff.title"></h2>
			<h3 class="md-display-1" ng-bind="'Clickbait: ' + otherDiff.clickbait"></h3>
			<div ng-bind-html="diffHtml"></div>
		</md-content>
		<div class="md-primary md-hue-2"
				layout="row"
				layout-align="space-between center"
				ng-if="otherDiff">
			<div layout-margin>
				<md-button class="md-primary md-hue-1 md-raised" ng-click="hideDiff()">
					<md-icon>arrow_back</md-icon>
					<md-tooltip md-delay="500">Go back to live preview</md-tooltip>
					Back to live preview
				</md-button>
			</div>
			<div flex></div>
			<div layout-margin>
				<md-button class="md-raised" ng-click="refreshDiff()" ng-if="::fullView">
					<md-tooltip md-delay="500">Refresh the diff</md-tooltip>
					Refresh
				</md-button>
			</div>
		</div>

		<!-- Show side-by-side edit -->
		<md-content layout-padding flex ng-if="sideEdit">
			<h2 class="md-display-1" ng-bind="'(#' + sideEdit.edit + ') ' + sideEdit.snapshotText"></h2>
			<h2 class="md-display-3" ng-bind="sideEdit.title"></h2>
			<h3 class="md-display-1" ng-bind="sideEdit.clickbait"></h3>
			<div class="edit-page-side-text" ng-bind="sideEdit.text"></div>
		</md-content>
		<div class="md-primary md-hue-2"
				layout-padding
				ng-if="sideEdit">
			<md-button class="md-primary md-hue-1 md-raised" ng-click="hideSideEdit()">
				<md-icon>arrow_back</md-icon>
				<md-tooltip md-delay="500">Go back to live preview</md-tooltip>
				Back to live preview
			</md-button>
		</div>
	</div>
</div>
