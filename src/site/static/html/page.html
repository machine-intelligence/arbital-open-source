<div id="subpage-{{::page.pageId}}" layout="{{::(isSingleColumn ? 'column' : 'row')}}">
	<!-- Hash anchor -->
	<a id="page-{{::page.pageId}}"></a>

	<!-- Primary column -->
	<div layout="column" class="vertical-layout-padding" flex>

		<div layout-gt-sm="row" layout-align-gt-sm="space-between end" ng-if="arb.pathService.path">
			<div arb-next-prev page-id="{{::page.pageId}}" whiteframe="::true"></div>
		</div>

		<!-- For user page display some additional info -->
		<div ng-if="::page.isUser()">
			<div ng-repeat="(domainId, domainMembership) in ::arb.userService.userMap[pageId].domainMembershipMap">
				<!-- Admins can edit the level of the user -->
				<div layout="row" ng-if="::arb.userService.user.isAdmin">
					<md-input-container flex>
						<label>User domain role ({{arb.stateService.domainMap[domainMembership.domainId].alias}})</label>
						<md-select ng-model="domainMembership.role"
								md-on-close="updateUserDomainRole(domainId)">
							<md-option value="banned">Banned</md-option>
							<md-option value="">None</md-option>
							<md-option value="default">Default</md-option>
							<md-option value="trusted">Trusted</md-option>
							<md-option value="reviewer">Reviewer</md-option>
							<md-option value="arbiter">Arbiter</md-option>
							<md-option value="arbitrator">Arbitrator</md-option>
						</md-select>
					</md-input-container>
				</div>
				<div ng-if="::!arb.userService.user.isAdmin">
					This user's role in
					<arb-page-title page-id="{{::domainId}}" is-link="true"></arb-page-title>
					domain is {{domainMembership.role}}.
				</div>
			</div>

		</div>

		<!-- Unlisted page -->
		<div class="md-whiteframe-1dp md-accent md-hue-1"
				layout-padding
				layout="row"
				layout-align="start center"
				ng-if="page.domainIds.length <= 0 && !page.isUser() && !page.isGroup()">
			<!-- Hasn't been submitted -->
			<div ng-if="page.domainSubmissionsCount() <= 0">
				This page is
				<arb-page-title page-id="14z" is-link="true" custom-page-title="unlisted."></arb-page-title>
				<md-button class="md-primary md-raised"
						ng-click="submitToDomain()"
						ng-if="page.permissions.edit.has">
					Submit for approval
				</md-button>
			</div>
			<!-- Has been submitted -->
			<div ng-if="page.domainSubmissionsCount() > 0">
				<span ng-if="page.domainSubmissions['1lw'].approverId == ''">
					This page has been submitted to the Math domain and is pending approval.
				</span>
				<md-button class='md-primary md-raised'
						ng-click="arb.pageService.approvePageToDomain(page.pageId, '1lw')"
						ng-if="page.domainSubmissions['1lw'].approverId == '' && arb.userService.user.trustMap['1lw'].level >= 2">
					Approve
				</md-button>
				<span ng-if="page.domainSubmissions['1lw'].approverId != ''">
					<arb-user-name user-id="{{::page.domainSubmissions['1lw'].approverId}}"></arb-user-name>
					added this page to the math domain, but the page is now orphaned.
				</span>
			</div>
		</div>

		<!-- Voting container -->
		<arb-vote-bar class="md-whiteframe-1dp" page-id="{{::page.pageId}}" ng-if="::page.hasVote"></arb-vote-bar>

		<!-- Lenses -->
		<div>

			<!-- Tab labels -->
			<div class="page-tabs"
					layout="row"
					layout-xs="column"
					layout-align="start end"
					layout-align-xs="start start"
					ng-if="::lenses.length > 1">
				<div class="page-tabs-header" layout="column" layout-align="center center">
					<div ng-bind="page.title"></div>
				</div>
				<a ng-repeat="lensObj in ::lenses"
						ng-init="lens=arb.stateService.pageMap[lensObj.lensId]"
						ng-href="{{arb.urlService.getPageUrl(page.pageId, {lensId: lens.pageId})}}"
						ng-click="tabClicked($event, lens.pageId)"
						class="page-tab lens-tab"
						ng-class="{'active-tab': lens.pageId == selectedLens.pageId}">
					<div layout="row" layout-align="start center" style="min-height: 33px">
						<div flex>
							<div ng-bind="::lensObj.lensName" style="white-space: nowrap"></div>
							<div class="md-caption tab-subtitle" ng-bind="::lensObj.lensSubtitle"></div>
						</div>
						<div class="page-tab-likes" layout="row" layout="start end">
							<md-icon class="small-icon on no-margins" ng-show="lens.myLikeValue > 0">thumb_up</md-icon>
							<md-icon class="small-icon off no-margins" md-svg-icon="thumb_up_outline" ng-show="lens.myLikeValue <= 0"></md-icon>
							<span class="like-count">{{lens.likeCount + lens.myLikeValue}}</span>
						</div>
					</div>
				</a>
				<div class="remainder" flex></div>
			</div>

			<!-- For each lens -->
			<div ng-repeat="lens in ::lenses" ng-if="lens.lensId === selectedLens.pageId">
				<!-- Lens body -->
				<div class="md-whiteframe-1dp">
					<div class="md-whiteframe-1dp page-lens-body">
						<!-- Header to show page's quality -->
						<div class="improvement-header {{arb.pageService.getQualityTag(selectedLens.tagIds)}}"
									ng-if="isQualityBarVisible()">
							<div layout="row" layout-align="start center">
								<div flex ng-switch="arb.pageService.getQualityTag(selectedLens.tagIds)">
									<span ng-switch-when="unassessed_meta_tag">
										This page's quality has not been assessed.
									</span>
									<span ng-switch-when="stub">
										This page is currently just a stub. Its content will be filled out over time.
									</span>
									<span ng-switch-when="start">
										The work on this page is just getting started. Its content is still in a rough state.
									</span>
									<span ng-switch-when="c-class">
										This page's content is still being worked on.
									</span>
								</div>
								<md-button href="#improvement"
										class="md-icon-button"
										aria-label="Jump down">
									<md-icon>arrow_downward</md-icon>
								</md-button>
							</div>

							<!-- Page improvement requests -->
							<div>
								<span ng-if="!selectedLens.contentRequests.improveStub.myLikeValue">
									You can vote to impove this page:
									<md-button class="short-button"
											ng-click="arb.signupService.submitContentRequest('improveStub', selectedLens)">
										<md-icon>plus_one</md-icon>
									</md-button>
								</span>
								<span ng-if="selectedLens.contentRequests.improveStub.myLikeValue">
									Thanks for voting to improve the page!
									<span ng-if="selectedLens.contentRequests.improveStub.likeCount > 1">
										({{page.contentRequests.improveStub.likeCount}} other people also voted for this page)
									</span>
								</span>
							</div>

						</div>

						<!-- Lens itself -->
						<div ng-style="{'min-height': 500}"
								layout="column"
								layout-align="center center"
								ng-if="!isLoaded(lens.lensId)">
							<md-progress-circular md-mode="indeterminate"></md-progress-circular>
						</div>
						<arb-lens class="reveal-after-render"
								page-id="{{::lens.lensId}}"
								lens-parent-id="{{::page.pageId}}"
								ng-if="isLoaded(lens.lensId)"></arb-lens>
					</div>

					<!-- Parents and tags -->
					<div layout="column" layout-padding>
						<div layout="column"
								layout-gt-sm="row"
								layout-align="start start"
								ng-if="selectedLens.parentIds.length > 0 || selectedLens.nonMetaTagIds.length > 0">
							<!-- Parents and children -->
							<div flex>
								<div layout-align="start center">
									<span>Parents:</span>
									<span ng-if="selectedLens.parentIds.length == 0">none</span>
									<span ng-repeat="(index, parentId) in selectedLens.parentIds">
										<span class="comma" ng-if="index > 0">,</span>
										<arb-page-title page-id="{{::parentId}}" is-link="true"></arb-page-title>
									</span>
								</div>
								<div layout-align="start center">
									<span>Children:</span>
									<a ng-href="{{arb.urlService.getExplorePageUrl(selectedLens.pageId)}}">
										<ng-pluralize count="selectedLens.childIds.length"
												when="{'0': 'none', 'one': 'one page', 'other': '{} pages'}"></ng-pluralize>
									</a>
								</div>
							</div>

							<!-- Tags -->
							<div layout-align="start center"
					 				ng-if="selectedLens.nonMetaTagIds.length > 0">
					 			<span>Tags:</span>
					 			<span ng-repeat="(index, tagId) in selectedLens.nonMetaTagIds">
					 				<span class="comma" ng-if="::(index > 0)">,</span>
					 				<arb-page-title page-id="{{::tagId}}" is-link="true"></arb-page-title>
					 			</span>
					 		</div>
					 	</div>
						<div class="md-caption" layout="column" layout-gt-sm="row">
							<a ng-href="{{arb.urlService.getEditPageUrl(selectedLens.pageId, {tabId: 4})}}" flex>
								<span ng-bind="selectedLens.changeLogs.length"></span>
								changes by
								<ng-pluralize count="selectedLens.computeAuthors().length"
										when="{'one': '{} author', 'other': '{} authors'}"></ng-pluralize>
							</a>
							<span ng-bind="selectedLens.viewCount"></span>
							&nbsp;views
						</div>
					</div>

					<!-- Add tags panel -->
					<div layout-padding ng-if="isTagsPanelVisible">
						<div arb-relationships
								class="edit-relationship-div"
								page-id="{{::selectedLens.pageId}}"
								use-normal-page-map="true"
								type="tag"
								force-edit-mode="true"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Answers section -->
		<a id="answers"></a>
		<div class="after-page-container" ng-if="::page.isQuestion()">
			<div class="user-page-panel md-whiteframe-1dp" layout="column">
				<md-toolbar class="md-hue-2">
					<div class="md-toolbar-tools">
						Answers ({{page.answers.length}})
						<div flex></div>
						<md-menu ng-if="::page.permissions.edit.has">
							<md-button ng-click="$mdOpenMenu($event)" class="md-icon-button" aria-label="Answer actions">
								<md-icon>more_vert</md-icon>
							</md-button>
							<md-menu-content>
								<!-- Delete answers -->
								<md-menu-item>
									<md-button ng-click="toggleDeleteAnswers()" aria-label="Toggle delete answers">
										Toggle delete answers
									</md-button>
								</md-menu-item>
							</md-menu-content>
						</md-menu>
					</div>
				</md-toolbar>
				<arb-answers page-id="{{::page.pageId}}" show-delete="showDeleteAnswer" layout-margin></arb-answers>
			</div>
		</div>

		<!-- Marks section -->
		<div class="after-page-container">
			<arb-marks ng-repeat="lens in ::lenses"
					class="reveal-after-render"
					page-id="{{::lens.lensId}}"
					ng-if="isLoaded(lens.lensId) && lens.lensId === selectedLens.pageId"></arb-marks>
		</div>

		<!-- Learn more section -->
		<div class="after-page-container md-whiteframe-1dp" ng-if="!selectedLens.isConcept()">
			<arb-learn-more ng-repeat="lens in ::lenses"
					class="reveal-after-render"
					page-id="{{::lens.lensId}}"
					ng-if="isLoaded(lens.lensId) && lens.lensId === selectedLens.pageId"></arb-learn-more>
		</div>

		<!-- Improvement section -->
		<div arb-page-improvement
				page="selectedLens"
				ng-if="selectedLens && selectedLens.editDomainId == '1' && !selectedLens.isConcept()"></div>

		<!-- Discussion section -->
		<div class="after-page-container" ng-if="arb.userService.userIsLoggedIn() && !selectedLens.isConcept()">
			<arb-page-discussion ng-repeat="lens in ::lenses"
					class="reveal-after-render"
					page-id="{{::lens.lensId}}"
					ng-if="isLoaded(lens.lensId) && lens.lensId === selectedLens.pageId"></arb-page-discussion>
		</div>
	</div>
</div>
